name: Dependency Update

on:
  schedule:
    # Run at 3 AM UTC every Monday
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Job 1: Update Dependencies
  update-deps:
    name: Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Update npm dependencies
        id: update
        run: |
          # Update package.json dependencies
          npx npm-check-updates -u --target minor

          # Install updated dependencies
          npm install

          # Check if there are changes
          if git diff --exit-code package.json package-lock.json; then
            echo "No updates available"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "Updates available"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: Run tests with updated dependencies
        if: steps.update.outputs.has_updates == 'true'
        run: npm test
        continue-on-error: true

      - name: Check for security issues
        if: steps.update.outputs.has_updates == 'true'
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Create Pull Request
        if: steps.update.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update npm dependencies'
          title: 'â¬†ï¸ Update npm dependencies'
          body: |
            ## Automated Dependency Update

            This PR updates npm dependencies to their latest minor versions.

            ### Changes
            ```diff
            $(git diff package.json | head -50)
            ```

            ### Checklist
            - [ ] Tests pass
            - [ ] No security vulnerabilities
            - [ ] Application builds successfully
            - [ ] Manual testing completed

            ---
            *This PR was automatically created by the dependency update workflow.*
          branch: deps/npm-update-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
          assignees: |
            ${{ github.repository_owner }}

  # Job 2: Security Updates
  security-updates:
    name: Security Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check for security vulnerabilities
        id: audit
        run: |
          npm audit --json > audit.json || true

          # Check if there are high or critical vulnerabilities
          high_vulns=$(cat audit.json | jq '.metadata.vulnerabilities.high // 0')
          critical_vulns=$(cat audit.json | jq '.metadata.vulnerabilities.critical // 0')

          if [ "$high_vulns" -gt 0 ] || [ "$critical_vulns" -gt 0 ]; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "high_count=$high_vulns" >> $GITHUB_OUTPUT
            echo "critical_count=$critical_vulns" >> $GITHUB_OUTPUT
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
          fi

      - name: Fix vulnerabilities
        if: steps.audit.outputs.has_vulnerabilities == 'true'
        run: |
          npm audit fix --force
          npm audit fix

      - name: Create Security PR
        if: steps.audit.outputs.has_vulnerabilities == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix(security): resolve npm vulnerabilities'
          title: 'ðŸ”’ Security: Fix npm vulnerabilities'
          body: |
            ## Security Update

            This PR fixes npm security vulnerabilities detected by npm audit.

            ### Vulnerabilities Found
            - **Critical**: ${{ steps.audit.outputs.critical_count }}
            - **High**: ${{ steps.audit.outputs.high_count }}

            ### Audit Report
            ```json
            $(cat audit.json | jq '.advisories' | head -100)
            ```

            ### âš ï¸ Important
            This is a security update and should be merged as soon as possible after review.

            ---
            *This PR was automatically created due to security vulnerabilities.*
          branch: security/npm-audit-${{ github.run_number }}
          delete-branch: true
          labels: |
            security
            priority:high
            automated
          assignees: |
            ${{ github.repository_owner }}

  # Job 3: Major Version Updates (Manual Review)
  major-updates:
    name: Check Major Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check for major updates
        id: check-major
        run: |
          npx npm-check-updates --target major --json > major-updates.json || true

          if [ -s major-updates.json ]; then
            updates=$(cat major-updates.json | jq 'length')
            if [ "$updates" -gt 0 ]; then
              echo "has_major_updates=true" >> $GITHUB_OUTPUT
            else
              echo "has_major_updates=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "has_major_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Major Update Issue
        if: steps.check-major.outputs.has_major_updates == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const updates = JSON.parse(fs.readFileSync('major-updates.json', 'utf8'));

            const updatesList = Object.entries(updates)
              .map(([pkg, version]) => `- [ ] ${pkg}: ${version}`)
              .join('\n');

            const body = `## Major Version Updates Available

            The following packages have major version updates available:

            ${updatesList}

            ### Action Required
            Major version updates may include breaking changes. Each update should be:
            1. Reviewed for breaking changes
            2. Updated individually
            3. Tested thoroughly
            4. Documented if APIs change

            ### Resources
            - Review changelogs for each package
            - Update code to accommodate breaking changes
            - Run comprehensive tests after each update

            ---
            *This issue was automatically created by the dependency update workflow.*`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“¦ Major dependency updates available - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['dependencies', 'breaking-change', 'needs-review']
            });

  # Job 4: License Compatibility Check
  license-check:
    name: License Compatibility
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check license compatibility
        run: |
          npx license-checker --production --json > licenses.json

          # Check for incompatible licenses
          incompatible=$(npx license-checker --production --exclude 'MIT,Apache-2.0,BSD-2-Clause,BSD-3-Clause,ISC,CC0-1.0' --json | jq 'length')

          if [ "$incompatible" -gt 0 ]; then
            echo "Found incompatible licenses"
            npx license-checker --production --exclude 'MIT,Apache-2.0,BSD-2-Clause,BSD-3-Clause,ISC,CC0-1.0'
            exit 1
          fi

      - name: Generate License Report
        run: |
          echo "# License Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          npx license-checker --production --summary >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Full Report" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>Click to expand</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat licenses.json | jq '.' | head -500 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

  # Job 5: Dependency Report
  dependency-report:
    name: Dependency Report
    runs-on: ubuntu-latest
    needs: [update-deps, security-updates, major-updates, license-check]
    if: always()
    steps:
      - name: Generate Report
        run: |
          echo "# Weekly Dependency Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Updates | ${{ needs.update-deps.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Updates | ${{ needs.security-updates.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Major Updates | ${{ needs.major-updates.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY