name: Security Check

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
  # Run before npm publish
  release:
    types: [created]

permissions:
  contents: read
  security-events: write

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # Scan for hardcoded secrets
    - name: TruffleHog Secret Scan
      uses: trufflesecurity/trufflehog@main
      continue-on-error: true
      with:
        path: ./
        extra_args: --only-verified

    # Block sensitive files from being committed
    - name: Check for Sensitive Files
      run: |
        echo "Checking for files that should not be tracked..."
        
        BLOCKED_FILES=""
        
        # Session data files
        if git ls-files | grep -E "session-analysis.*\.(json|md)$|session-.*\.json$"; then
          BLOCKED_FILES="$BLOCKED_FILES\n- Session analysis/data files"
        fi
        
        # Environment variable extraction files
        if git ls-files | grep -iE "env-vars|production-.*extracted"; then
          BLOCKED_FILES="$BLOCKED_FILES\n- Environment variable files"
        fi
        
        # Actual .env files with secrets
        if git ls-files | grep -E "^\.env$|^\.env\.local$|^\.env\.production$|^\.env\.staging$"; then
          BLOCKED_FILES="$BLOCKED_FILES\n- .env files with secrets"
        fi
        
        if [ -n "$BLOCKED_FILES" ]; then
          echo "❌ Found sensitive files that should not be tracked:"
          echo -e "$BLOCKED_FILES"
          echo ""
          echo "Run: git rm --cached <file> to remove from tracking"
          exit 1
        fi
        
        echo "✅ No sensitive files found in repo"

    # Check for sensitive patterns in source code
    - name: Check for Hardcoded Values
      run: |
        echo "Checking for hardcoded development values..."

        # Check for development fallback values
        if grep -r "|| 'dev-" --include="*.ts" --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=tests .; then
          echo "⚠️ Found hardcoded development fallback values"
        fi

        # Check for actual secret strings (long base64/hex, not property names)
        if grep -rE "(sk-[A-Za-z0-9]{20,}|AKIA[A-Z0-9]{16}|ghp_[A-Za-z0-9]{36}|npm_[A-Za-z0-9]{36})" --include="*.ts" --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=tests .; then
          echo "❌ Found what looks like a real API key or token!"
          exit 1
        fi

        echo "✅ No hardcoded secrets found in source code"

    # Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    # Verify npm package contents
    - name: Check NPM Package Contents
      run: |
        echo "Checking npm package contents..."
        npm pack --dry-run > package-contents.txt

        # Check for database seed/migration files (schema is needed at runtime)
        if grep -E "dist/db/seed\.|dist/db/migrate\." package-contents.txt; then
          echo "❌ Database seed/migration files detected in package!"
          grep -E "dist/db/seed\.|dist/db/migrate\." package-contents.txt
          exit 1
        fi

        # Check for test/backup implementations
        if grep -E "sendMessage-(complex|revised|truly)" package-contents.txt; then
          echo "❌ Test/backup implementation files detected in package!"
          grep -E "sendMessage-(complex|revised|truly)" package-contents.txt
          exit 1
        fi

        echo "✅ NPM package contents are clean"

    # Check built files for secrets
    - name: Check Built Files for Secrets
      run: |
        echo "Checking built files for hardcoded secrets..."

        # Check for development values in dist
        if grep -r "dev-secret\|change-in-production" dist/ --include="*.js"; then
          echo "❌ Found hardcoded development values in built files!"
          exit 1
        fi

        # Check for database URLs
        if grep -rE "postgres(ql)?://[^\"'\s]+" dist/ --include="*.js"; then
          echo "❌ Found hardcoded database URLs in built files!"
          exit 1
        fi

        echo "✅ No secrets found in built files"

    # Run dependency audit
    - name: NPM Audit
      run: |
        echo "Running npm audit..."
        # Only audit production dependencies (dev deps like vercel have known issues)
        npm audit --omit=dev --audit-level=high || true

        # Generate audit report for production deps only
        npm audit --omit=dev --json > audit.json || true

        # Check for high/critical vulnerabilities in production deps
        HIGH_VULNS=$(cat audit.json | jq '.metadata.vulnerabilities.high // 0')
        CRITICAL_VULNS=$(cat audit.json | jq '.metadata.vulnerabilities.critical // 0')

        if [ "$CRITICAL_VULNS" -gt 0 ]; then
          echo "⚠️ Found $CRITICAL_VULNS critical vulnerabilities in production dependencies"
          cat audit.json | jq '.vulnerabilities | to_entries[] | select(.value.severity == "critical") | .key'
        fi

        if [ "$HIGH_VULNS" -gt 10 ]; then
          echo "⚠️ Found $HIGH_VULNS high vulnerabilities in production deps (threshold: 10)"
        fi

        echo "✅ Dependency audit completed"

    # Validate environment configuration
    - name: Check Environment Configuration
      run: |
        echo "Checking environment configuration..."

        # Ensure .env files are gitignored
        if git ls-files | grep -E "^\.env$|^\.env\.local$|^\.env\.production$|^\.env\.staging$"; then
          echo "❌ .env files are not properly gitignored!"
          git ls-files | grep -E "\.env"
          exit 1
        fi

        # Check .env.example if it exists
        if [ -f ".env.example" ]; then
          if grep -E "ey[A-Za-z0-9+/]{20,}|sk-[A-Za-z0-9]|npm_[A-Za-z0-9]" .env.example; then
            echo "❌ .env.example contains what looks like real tokens!"
            exit 1
          fi
        fi

        echo "✅ Environment configuration is secure"

    # Validate .npmignore configuration
    - name: Validate NPM Ignore Configuration
      run: |
        echo "Checking .npmignore configuration..."

        # Check critical patterns are in .npmignore
        REQUIRED_PATTERNS=(
          "\.env"
          "src/"
          "tests/"
        )

        for pattern in "${REQUIRED_PATTERNS[@]}"; do
          if ! grep -q "$pattern" .npmignore 2>/dev/null; then
            echo "⚠️ Missing pattern in .npmignore: $pattern"
          fi
        done

        echo "✅ .npmignore configuration checked"

    # Generate security report
    - name: Generate Security Report
      if: always()
      run: |
        echo "## Security Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Hardcoded secrets scan: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- Package contents check: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- Environment validation: ✅" >> $GITHUB_STEP_SUMMARY
        echo "- Dependency audit: ✅" >> $GITHUB_STEP_SUMMARY

    # Upload artifacts for debugging
    - name: Upload Security Artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: security-check-artifacts
        if-no-files-found: ignore
        path: |
          package-contents.txt
          audit.json