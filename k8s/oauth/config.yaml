apiVersion: v1
kind: ConfigMap
metadata:
  name: oauth-config
  namespace: couchloop
  labels:
    app: oauth-service
data:
  oauth-config.yaml: |
    server:
      port: 3000
      host: 0.0.0.0
      cors:
        enabled: true
        origins:
          - https://couchloop.com
          - https://app.couchloop.com
        credentials: true
        maxAge: 86400

    oauth:
      issuer: https://auth.couchloop.com
      audience: https://api.couchloop.com
      authorizationEndpoint: /oauth/authorize
      tokenEndpoint: /oauth/token
      userInfoEndpoint: /oauth/userinfo
      jwksEndpoint: /oauth/.well-known/jwks.json

      # Token configuration
      tokens:
        accessTokenTTL: 900          # 15 minutes
        refreshTokenTTL: 2592000     # 30 days
        idTokenTTL: 3600             # 1 hour
        authCodeTTL: 600             # 10 minutes

      # Security settings
      security:
        pkceRequired: true
        stateRequired: true
        nonceRequired: true
        dpopEnabled: true
        tokenRotation: true

      # Scopes
      scopes:
        - openid
        - profile
        - email
        - offline_access
        - read:sessions
        - write:sessions
        - read:insights
        - write:insights

    # Rate limiting
    rateLimiting:
      enabled: true
      windowMs: 60000        # 1 minute
      max: 100               # requests per window
      skipSuccessfulRequests: false
      standardHeaders: true
      legacyHeaders: false

      # Endpoint-specific limits
      endpoints:
        /oauth/token:
          windowMs: 60000
          max: 10
        /oauth/authorize:
          windowMs: 60000
          max: 20
        /api/:
          windowMs: 60000
          max: 100

    # Security monitoring
    monitoring:
      enabled: true
      alerting:
        channels:
          - log
          - slack
          - email
        thresholds:
          failedLogins: 5
          tokenThefts: 1
          anomalies: 10
      webhooks:
        - url: ${SECURITY_WEBHOOK_URL}
          events:
            - critical
            - high

    # GDPR compliance
    gdpr:
      enabled: true
      consentRequired: true
      dataRetention:
        default: 2555        # 7 years
        sessions: 90         # 90 days
        tokens: 30           # 30 days
      parental:
        ageEU: 16
        ageUS: 13
      breach:
        notificationWindow: 72  # hours

    # Logging
    logging:
      level: info
      format: json
      outputs:
        - console
        - file
      redact:
        - password
        - secret
        - token
        - key

    # Health checks
    health:
      liveness:
        path: /health
        timeout: 5000
      readiness:
        path: /ready
        timeout: 3000
        checks:
          - database
          - redis
          - oauth

    # Metrics
    metrics:
      enabled: true
      port: 9090
      path: /metrics

---
apiVersion: v1
kind: Secret
metadata:
  name: oauth-secrets
  namespace: couchloop
  labels:
    app: oauth-service
type: Opaque
stringData:
  # Generate with: openssl rand -hex 32
  jwt-secret: "CHANGE_ME_64_CHAR_HEX_STRING"
  encryption-key: "CHANGE_ME_64_CHAR_HEX_STRING"
  state-secret: "CHANGE_ME_64_CHAR_HEX_STRING"

  # Database URL
  database-url: "postgresql://user:password@postgres:5432/couchloop"

  # Redis URL
  redis-url: "redis://:password@redis:6379/0"

  # Security webhook
  security-webhook-url: "https://alerts.couchloop.com/webhook"

---
apiVersion: v1
kind: Secret
metadata:
  name: oauth-providers
  namespace: couchloop
  labels:
    app: oauth-service
type: Opaque
stringData:
  # Google OAuth
  google-client-id: "CHANGE_ME_GOOGLE_CLIENT_ID"
  google-client-secret: "CHANGE_ME_GOOGLE_CLIENT_SECRET"
  google-redirect-uri: "https://couchloop.com/oauth/callback/google"

  # GitHub OAuth
  github-client-id: "CHANGE_ME_GITHUB_CLIENT_ID"
  github-client-secret: "CHANGE_ME_GITHUB_CLIENT_SECRET"
  github-redirect-uri: "https://couchloop.com/oauth/callback/github"

  # Microsoft OAuth (future)
  microsoft-client-id: ""
  microsoft-client-secret: ""

  # Apple OAuth (future)
  apple-client-id: ""
  apple-team-id: ""
  apple-key-id: ""
  apple-private-key: ""